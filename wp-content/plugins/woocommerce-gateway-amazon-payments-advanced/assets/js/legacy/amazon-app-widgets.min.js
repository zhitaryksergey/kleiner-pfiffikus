jQuery(function(t){var o,r,i,a=!1,d=amazon_payments_advanced_params.render_address_widget,s=["AT","DE"];function c(){void 0!==console.log&&console.log.apply(console,arguments)}function m(e){var n="";return"object"!=typeof e||("function"==typeof e.getErrorCode&&(n+="("+e.getErrorCode()+") "),"function"==typeof e.getErrorMessage&&(n+=e.getErrorMessage())),n}function _(){return"amazon_payments_advanced"===t("input[name=payment_method]:checked").val()}function l(e){e&&e.getAmazonOrderReferenceId&&(o=e.getAmazonOrderReferenceId()),n(),z()}function p(e){o||(o=e.getAmazonOrderReferenceId(),n())}function n(){t("input.amazon-reference-id").remove();var e='<input class="amazon-reference-id" type="hidden" name="amazon_reference_id" value="'+o+'" />';t("form.checkout").append(e),t("form#order_review").append(e)}function u(e){if(!r){var n='<input class="amazon-billing-agreement-id" type="hidden" name="amazon_billing_agreement_id" value="'+(r=e.getAmazonBillingAgreementId())+'" />';t("form.checkout").append(n),t("form#order_review").append(n),t("#amazon_consent_widget").show()}}function f(e,n){t("#"+e).length&&t("#"+e).val(n||"").change()}function g(e){var n=e.split(" ");return{first_name:n.shift(),last_name:n.join(" ")||"."}}function y(e){!function(e){var n=Object.keys(e);for(var a in n){var o=n[a];"undefined"===e[o]&&delete e[o]}}(e);var n=g(e.Name),a={first_name:n.first_name,last_name:n.last_name};if(e.CountryCode&&s.includes(e.CountryCode))if(e.AddressLine3){var o=e.AddressLine1+" "+e.AddressLine2;a.company=o.trim(),a.address_1=e.AddressLine3}else e.AddressLine2?(a.company=e.AddressLine1,a.address_1=e.AddressLine2):a.address_1=e.AddressLine1;else{var r=[e.AddressLine1,e.AddressLine2,e.AddressLine3].filter(function(e){return e});3===r.length?(a.company=r[0],a.address_1=r[1],a.address_2=r[2]):2===r.length?(a.address_1=r[0],a.address_2=r[1]):a.address_1=r[0]}return a.country=e.CountryCode,a.phone=e.Phone,a.city=e.City,a.postcode=e.PostalCode,a.state=e.StateOrRegion,a}function v(e,n){var a=Object.keys(n);for(var o in a){var r=a[o];f(e+r,n[r])}}function h(e){!function(){var e=["billing_first_name","billing_last_name","billing_company","billing_address_1","billing_address_2","billing_phone","billing_city","billing_postcode","billing_state","billing_country","billing_email","shipping_first_name","shipping_last_name","shipping_company","shipping_address_1","shipping_address_2","shipping_phone","shipping_city","shipping_postcode","shipping_state","shipping_country"];for(var n in e)f(e[n],"")}();var n=e.Destination&&e.Destination.PhysicalDestination,a=e.BillingAddress&&e.BillingAddress.PhysicalAddress,o=n?y(e.Destination.PhysicalDestination):{},r=null;if(a)r=y(e.BillingAddress.PhysicalAddress);else{var t=g(e.Buyer.Name);(r=Object.assign({},o)).first_name=t.first_name,r.last_name=t.last_name}r.email=e.Buyer.Email,r.phone=r.phone||e.Buyer.Phone,v("billing_",r),n&&v("shipping_",o)}function z(){b(),t.ajax({type:"post",url:amazon_payments_advanced_params.ajax_url,data:{action:"amazon_get_order_reference",nonce:amazon_payments_advanced_params.order_reference_nonce,order_reference_id:o},success:function(e){h(e),k(),t("body").trigger("update_checkout")},error:function(e,n,a){c("Error encountered in amazon_get_order_reference:",e.responseJSON||a),k()}})}function e(){if(!a&&0!==t("#pay_with_amazon").length){var n=!0;"optimal"===amazon_payments_advanced_params.redirect_authentication&&window.innerWidth<=800&&(n=!1);var e={type:amazon_payments_advanced_params.button_type,color:amazon_payments_advanced_params.button_color,size:amazon_payments_advanced_params.button_size,authorization:function(){var e={scope:"profile postal_code payments:widget payments:shipping_address payments:billing_address",popup:n};amazon.Login.authorize(e,amazon_payments_advanced_params.redirect)},onError:function(e){var n=m(e);c("Error encountered in OffAmazonPayments.Button",n?": "+n:"")}};""!==amazon_payments_advanced_params.button_language&&(e.language=amazon_payments_advanced_params.button_language),OffAmazonPayments.Button("pay_with_amazon",amazon_payments_advanced_params.seller_id,e),a=!0}}function w(e){0===t("."+e+"__field-wrapper").children(":not(.hidden)").length?t("."+e).addClass("hidden"):t("."+e).removeClass("hidden")}function b(e){(e=e||t("form.checkout")).addClass("processing").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}function k(e){(e=e||t("form.checkout")).removeClass("processing").unblock()}e(),i=0<t("#amazon_addressbook_widget").length,d&&i?function(){var e={sellerId:amazon_payments_advanced_params.seller_id,onReady:function(){C(),t(document).trigger("wc_amazon_pa_widget_ready")},onOrderReferenceCreate:p,design:{designMode:"responsive"},onError:function(e){var n=m(e);c("Error encountered in OffAmazonPayments.Widgets.AddressBook",n?": "+n:"")}},n=amazon_payments_advanced_params.is_recurring,a=amazon_payments_advanced_params.declined_code;if("AmazonRejected"===a)return B();n&&(e.agreementType="BillingAgreement",e.onReady=function(e){u(e),C(),O(),t(document).trigger("wc_amazon_pa_widget_ready")});a&&(e.displayMode="Read",e.amazonOrderReferenceId=amazon_payments_advanced_params.reference_id,delete e.onOrderReferenceCreate);new OffAmazonPayments.Widgets.AddressBook(e).bind("amazon_addressbook_widget")}():C(),w("woocommerce-billing-fields"),w("woocommerce-shipping-fields"),w("woocommerce-additional-fields"),amazon_payments_advanced_params.multi_currency_supported&&amazon_payments_advanced_params.multi_currency_reload_wallet&&t(document.body).on("updated_checkout",function(){t.ajax({url:amazon_payments_advanced_params.ajax_url,type:"post",data:{action:"amazon_get_currency",nonce:amazon_payments_advanced_params.multi_currency_nonce},success:function(e){C(e)}})});var A=null;function C(e){if(!amazon_payments_advanced_params.declined_redirect_url){if(!A){var n={sellerId:amazon_payments_advanced_params.seller_id,design:{designMode:"responsive"},onPaymentSelect:z,onError:function(e){var n=m(e);c("Error encountered in OffAmazonPayments.Widgets.Wallet",n?": "+n:"")}};amazon_payments_advanced_params.reference_id&&(o=amazon_payments_advanced_params.reference_id,n.amazonOrderReferenceId=o,n.onPaymentSelect=l),d&&i||(n.onOrderReferenceCreate=p),amazon_payments_advanced_params.is_recurring&&(n.agreementType="BillingAgreement",r?n.amazonBillingAgreementId=r:n.onReady=function(e){u(e),O()}),A=new OffAmazonPayments.Widgets.Wallet(n)}if(amazon_payments_advanced_params.multi_currency_supported){var a=e||amazon_payments_advanced_params.current_currency;A.setPresentmentCurrency(a)}A.bind("amazon_wallet_widget")}}function O(){amazon_payments_advanced_params.is_recurring&&r&&new OffAmazonPayments.Widgets.Consent({sellerId:amazon_payments_advanced_params.seller_id,amazonBillingAgreementId:r,design:{designMode:"responsive"},onReady:P,onConsent:P,onError:function(e){var n=m(e);c("Error encountered in OffAmazonPayments.Widgets.Consent",n?": "+n:"")}}).bind("amazon_consent_widget")}function P(e){var n=e.getConsentStatus();if("undefined"!==n)return t("#place_order").css("opacity","true"==n?1:.5),void t("#place_order").prop("disabled","true"!=n);t("#amazon_consent_widget").hide()}function B(){amazon_payments_advanced_params.declined_redirect_url&&t("body").on("updated_checkout",function(){t("html, body").scrollTop(0),setTimeout(function(){window.location=amazon_payments_advanced_params.declined_redirect_url},3e3)})}function R(e,n){t(".woocommerce-NoticeGroup-checkout, .woocommerce-error, .woocommerce-message").remove(),n.prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-checkout">'+e+"</div>"),n.removeClass("processing").unblock(),n.find(".input-text, select, input:checkbox").trigger("validate").blur(),function(){var e=t(".woocommerce-NoticeGroup-updateOrderReview, .woocommerce-NoticeGroup-checkout");e.length||(e=t(".form.checkout"));t.scroll_to_notices(e)}(),t(document.body).trigger("checkout_error")}t("body").on("click","#amazon-logout",function(){amazon.Login.logout(),document.cookie="amazon_Login_accessToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT",window.location=amazon_payments_advanced_params.redirect_url}),t("form.checkout").on("checkout_place_order",function(){var e=[":input[name=billing_email]",":input[name=billing_first_name]",":input[name=billing_last_name]",":input[name=account_username]",":input[name=account_password]",":input[name=createaccount]"].join(",");t(this).find(e).each(function(){var e=t(this);""===e.val()&&e.is(":hidden")&&e.attr("disabled","disabled"),"createaccount"===e.attr("name")&&t("#createaccount").length&&e.prop("checked",t("#createaccount").is(":checked"))})}),t("body").on("updated_checkout",O),t("body").on("updated_checkout",e),t("body").on("updated_cart_totals",function(){a=!1,e()}),t(window.document).on("wc_amazon_pa_widget_ready",function(){B()}),t("form.checkout").on("checkout_place_order",function(e){if(!_())return!0;if(!amazon_payments_advanced_params.is_sca)return!0;var n=t(this);return OffAmazonPayments.initConfirmationFlow(amazon_payments_advanced_params.seller_id,o,function(e){!function(o,r){b(r),t.ajax({type:"post",url:amazon_payments_advanced_params.ajax_url,data:{action:"amazon_sca_processing",nonce:amazon_payments_advanced_params.sca_nonce,data:t("form.checkout").serialize()},success:function(e){if("success"===e.result)o.success();else if("failure"===e.result){if(o.error(),!0===e.reload)return void window.location.reload();!0===e.refresh&&t(document.body).trigger("update_checkout"),R(e.messages,r)}},error:function(e,n,a){o.error(),R('<div class="woocommerce-error">'+a+"</div>",r)}})}(e,n)}),e.preventDefault(),!1}),t("body").on("updated_checkout",function(){if(_()){if(function(e,n){var a=t("#"+e+"_"+n+"_field"),o=t("#"+e+"_"+n).val();a.addClass("hidden"),t(".woocommerce-"+e+"-fields").addClass("hidden"),null!=o&&""!==o||(a.removeClass("hidden"),t(".woocommerce-"+e+"-fields").removeClass("hidden"))}("shipping","state"),0<t(".woocommerce-billing-fields .woocommerce-billing-fields__field-wrapper > *").length&&t(".woocommerce-billing-fields").insertBefore("#payment"),0<t(".woocommerce-shipping-fields .woocommerce-shipping-fields__field-wrapper > *").length){var e=t("#ship-to-different-address");e.find(":checkbox#ship-to-different-address-checkbox").hide(),e.find("span").text(amazon_payments_advanced_params.shipping_title),t(".woocommerce-shipping-fields").insertBefore("#payment")}t(".woocommerce-additional-fields").insertBefore("#payment")}})});
