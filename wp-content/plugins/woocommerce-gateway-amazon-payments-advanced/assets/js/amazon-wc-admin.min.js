!function(l){var o={simple_path_form_id:"simple_path",payment_region_input:l("#woocommerce_amazon_payments_advanced_payment_region"),button_language_input:l("#woocommerce_amazon_payments_advanced_button_language"),authorization_mode:l("#woocommerce_amazon_payments_advanced_authorization_mode"),payment_capture:l("#woocommerce_amazon_payments_advanced_payment_capture"),action_url:"#",spId:"",register_now_link:l("a.register_now"),delete_settings_link:l("a.delete-settings"),onboarding_version:amazon_admin_params.onboarding_version,locale:amazon_admin_params.locale,home_url:amazon_admin_params.home_url,merchant_unique_id:amazon_admin_params.merchant_unique_id,public_key:amazon_admin_params.public_key,exchange_url:amazon_admin_params.simple_path_url,privacy_url:amazon_admin_params.privacy_url,site_description:amazon_admin_params.description,login_redirect_url:amazon_admin_params.login_redirect_url,woo_version:amazon_admin_params.woo_version,plugin_version:amazon_admin_params.plugin_version,poll_timer:!1,poll_interval:3e3,main_setting_form:l("#mainform"),init_dynamic_options:function(n,a,t){var i=n.data("wc-apa-all-options");if(void 0!==i)return i;i={},n.data("wc-apa-all-options",i),n.children("option").each(function(){var e=l(this).prop("value");i[e]=l(this).text()});function e(){var e=a.val();o.select_rebuild(n,t,e)}return e(),a.on("change",e),i},init_settings:function(){l.each(amazon_admin_params.language_combinations,function(e,n){n.unshift(""),amazon_admin_params.language_combinations[e]=n}),o.init_dynamic_options(o.button_language_input,o.payment_region_input,amazon_admin_params.language_combinations),o.init_dynamic_options(o.authorization_mode,o.payment_capture,{"":["sync"],authorize:!0,manual:!0}),o.payment_region_on_change(),o.create_form(),o.payment_region_input.on("change",this.payment_region_on_change),o.register_now_link.on("click",this.register_link_on_click),o.delete_settings_link.on("click",this.delete_settings_on_click),l(document).on("click","a.wcapa-toggle-section",this.toggle_visibility)},select_rebuild:function(t,e,n){var i=t.data("wc-apa-all-options"),a=e[n];"boolean"==typeof e[n]&&(a=e[n]=Object.keys(i)),a=a.slice();var o=t.children("option:selected"),r=o.prop("value");-1===a.indexOf(r)?(t.children("option").remove(),r=!1):t.children("option").not(":selected").remove();var _=!1;l.each(a,function(e,n){if(r!==n){var a=l("<option/>",{value:n}).html(i[n]);r&&!_?o.before(a):t.append(a)}else _=!0}),r||t.children().first().prop("selected",!0)},payment_region_on_change:function(){l(".wcapa-seller-central-secret-key-url").attr("href",amazon_admin_params.secret_keys_urls[o.get_region_selected()]),"jp"===o.get_region_selected()?(o.register_now_link.attr("href",o.get_simple_path_url()),o.register_now_link.attr("target","_blank")):(o.register_now_link.attr("href","#"),o.register_now_link.removeAttr("target"),o.action_url=o.get_simple_path_url(),o.spId=o.get_spId(),l("#"+o.simple_path_form_id).attr("action",o.action_url),l("input[name=spId]").val(o.spId))},set_credentials_values:function(e,n,a){l("#woocommerce_amazon_payments_advanced_merchant_id").val(e),l("#woocommerce_amazon_payments_advanced_store_id").val(n),l("#woocommerce_amazon_payments_advanced_public_key_id").val(a)},register_link_on_click:function(e){if(l(this).is(".button-disabled"))return e.preventDefault(),void e.stopPropagation();"jp"!==o.get_region_selected()&&(e.preventDefault(),document.getElementById(o.simple_path_form_id).submit.click(),o.main_setting_form.block({message:"Waiting for Credentials From Amazon Seller Central",overlayCSS:{background:"#f1f1f1",opacity:.5}}),o.poll_timer=setTimeout(o.poll_for_keys,o.poll_interval)),l("#woocommerce_amazon_payments_advanced_redirect_authentication").val("optimal")},delete_settings_on_click:function(e){if(l(this).is(".button-disabled"))return e.preventDefault(),void e.stopPropagation();e.preventDefault(),confirm("Disconnecting will clear your saved merchant credentials -- you will need to reconnect and sign into Amazon Pay in order to activate Amazon Pay again.")&&l.ajax({url:amazon_admin_params.ajax_url,data:{action:"amazon_delete_credentials",nonce:amazon_admin_params.credentials_nonce},type:"POST",success:function(e){location.reload()}})},create_form:function(){l(".wrap.woocommerce").append(l("<form/>",{id:o.simple_path_form_id,action:o.action_url,method:"post",target:"_blank"}).append(l("<input/>",{type:"hidden",name:"spId",value:o.spId}),l("<input/>",{type:"hidden",name:"onboardingVersion",value:o.onboarding_version}),l("<input/>",{type:"hidden",name:"publicKey",value:o.public_key}),l("<input/>",{type:"hidden",name:"keyShareURL",value:o.exchange_url}),l("<input/>",{type:"hidden",name:"locale",value:o.locale}),l("<input/>",{type:"hidden",name:"merchantLoginDomains[]",value:o.home_url}),l("<input/>",{type:"hidden",name:"spSoftwareVersion",value:o.woo_version}),l("<input/>",{type:"hidden",name:"spAmazonPluginVersion",value:o.plugin_version}),l("<input/>",{type:"hidden",name:"merchantLoginRedirectURLs[]",value:o.exchange_url}),l("<input/>",{type:"hidden",name:"merchantLoginRedirectURLs[]",value:o.login_redirect_url}),l("<input/>",{type:"hidden",name:"merchantPrivacyNoticeURL",value:o.privacy_url}),l("<input/>",{type:"hidden",name:"merchantStoreDescription",value:o.site_description}),l("<input/>",{type:"hidden",name:"source",value:"SPPL"}),l("<input/>",{type:"submit",name:"submit",style:"display:none",value:"submit"})))},get_region_selected:function(){return o.payment_region_input.val()},get_simple_path_url:function(){return amazon_admin_params.simple_path_urls[o.get_region_selected()]},get_spId:function(){return amazon_admin_params.spids[o.get_region_selected()]},poll_for_keys:function(){clearTimeout(o.poll_timer),l.ajax({url:amazon_admin_params.ajax_url,data:{action:"amazon_check_credentials",nonce:amazon_admin_params.credentials_nonce},type:"GET",success:function(e){if(-1!==e.data)o.set_credentials_values(e.data.merchant_id,e.data.store_id,e.data.public_key_id),o.main_setting_form.unblock(),l("#mainform .notice-error").remove(),o.register_now_link.toggleClass("button-disabled",!0),o.delete_settings_link.toggleClass("button-disabled",!1);else{if(!1===o.poll_timer)return;o.poll_timer=setTimeout(o.poll_for_keys,o.poll_interval)}}})},toggle_visibility:function(e){e.preventDefault();var n=l(l(this).data("toggle"));n.toggleClass("hidden"),l(this).hasClass("wcapa-toggle-scroll")&&l("html, body").stop().animate({scrollTop:n.offset().top-100},1e3,"swing")}};l("body").hasClass("woocommerce_page_wc-settings")&&(o.init_settings(),l("#import_submit").click(function(e){window.onbeforeunload=null})),l("body").hasClass("post-type-shop_order")&&jQuery("#woocommerce-amazon-payments-advanced.postbox").each(function(){l(this).on("click",'a[href="#toggle-refunds"]',function(){var e=l("html, body"),n=jQuery(".woocommerce_order_items_wrapper");return e.stop().animate({scrollTop:n.offset().top-100},1e3,"swing",function(){l("#woocommerce-order-items .refund-items").click()}),!1})})}(jQuery);
